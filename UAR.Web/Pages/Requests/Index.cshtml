@page
@model UAR.Web.Pages.Requests.IndexModel

@if (TempData["DebugEmailSubject"] is string debugSubject)
{
    <div class="modal fade show" id="debugEmailModal" tabindex="-1" style="display: block;" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Debug Approval Email</h5>
                    <a class="btn-close" href="@Url.Page("/Requests/Index")" aria-label="Close"></a>
                </div>
                <div class="modal-body">
                    <p class="mb-1"><strong>Subject:</strong> @debugSubject</p>
                    <pre class="bg-light p-3 rounded-3">@TempData["DebugEmailBody"]</pre>
                    <div class="d-flex flex-wrap gap-2">
                        @if (TempData["DebugEmailApproveUrl"] is string approveUrl && !string.IsNullOrWhiteSpace(approveUrl))
                        {
                            <a class="btn btn-success" href="@approveUrl">Approve</a>
                        }
                        @if (TempData["DebugEmailRejectUrl"] is string rejectUrl && !string.IsNullOrWhiteSpace(rejectUrl))
                        {
                            <a class="btn btn-danger" href="@rejectUrl">Reject</a>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-outline-secondary" href="@Url.Page("/Requests/Index")">Close</a>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

<h2 class="mb-3">User Access Request Log</h2>
<form method="get" class="bg-white rounded-4 shadow-sm p-3 mb-3">
    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label" asp-for="RequestNumberQuery">UAR Number</label>
            <input class="form-control" asp-for="RequestNumberQuery" placeholder="Search by UAR number" />
        </div>
        <div class="col-md-3">
            <label class="form-label" asp-for="SubmitterQuery">Submitter</label>
            <input class="form-control" asp-for="SubmitterQuery" placeholder="Search by submitter" />
        </div>
        <div class="col-md-3">
            <label class="form-label" asp-for="ApproverQuery">Approver</label>
            <input class="form-control" asp-for="ApproverQuery" placeholder="Search by approver" />
        </div>
        <div class="col-md-3">
            <label class="form-label" asp-for="RdoApproverQuery">RDO Approver</label>
            <input class="form-control" asp-for="RdoApproverQuery" placeholder="Search by RDO approver" />
        </div>
        <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit">Filter</button>
            <a class="btn btn-outline-secondary" href="@Url.Page("/Requests/Index")">Clear</a>
        </div>
    </div>
</form>
<div class="table-responsive bg-white rounded-4 shadow-sm p-3">
    <table class="table table-sm align-middle">
        <thead>
            <tr>
                <th>Request #</th>
                <th>Submitted</th>
                <th>Employee</th>
                <th>Program</th>
                <th>Status</th>
                <th>Authorized Approver</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var request in Model.Requests)
            {
                <tr>
                    <td>@request.RequestNumber</td>
                    <td>@request.SubmittedOn.ToLocalTime().ToString("g")</td>
                    <td>@request.EmployeeFirstName @request.EmployeeLastName</td>
                    <td>@request.Program1</td>
                    <td>@request.Status</td>
                    <td>
                        <div>@request.AuthorizedApproverName</div>
                        <div class="text-muted small">@request.AuthorizedApproverEmail</div>
                    </td>
                    <td class="text-end">
                        <a class="btn btn-sm btn-outline-primary" asp-page="/Requests/Details" asp-route-id="@request.Id">View</a>
                        @if (string.Equals(request.Status, "Approved", StringComparison.OrdinalIgnoreCase))
                        {
                            <button class="btn btn-sm btn-outline-secondary ms-2" disabled>Approved</button>
                        }
                        else
                        {
                            <a class="btn btn-sm btn-outline-secondary ms-2" asp-page="/Requests/Edit" asp-route-id="@request.Id">Edit</a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
